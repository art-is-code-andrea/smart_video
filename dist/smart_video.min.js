export class SmartVideo{constructor(t={}){const e={selector:"[data-aic-video]",lang:"en",consent:{youtube:!1,vimeo:!1,tiktok:!1,instagram:!1,dailymotion:!1,local:!0},translations:{en:{msg:"Accept {vendor} cookies to watch the video",btn:"Accept"},it:{msg:"Accetta i cookie di {vendor} per guardare il video",btn:"Accetta"}},providers:{youtube:{pattern:/youtube\.com|youtu\.be/,getEmbed:(t,e)=>{const i=1==e?1:0,o=i?"&mute=1":"",s=new URL(t),r=s.searchParams.get("list");if(r)return`https://www.youtube-nocookie.com/embed/videoseries?list=${r}&autoplay=${i}${o}`;return`https://www.youtube-nocookie.com/embed/${t.includes("youtu.be/")?s.pathname.substring(1):s.searchParams.get("v")}?autoplay=${i}${o}&rel=0&enablejsapi=1`}},vimeo:{pattern:/vimeo\.com/,getEmbed:(t,e)=>`https://player.vimeo.com/video/${t.split("?")[0].split("/").filter(t=>t.length>0).pop()}?dnt=1&autoplay=${1==e?1:0}`},instagram:{pattern:/instagram\.com/,getEmbed:t=>`https://www.instagram.com/p/${t.split("?")[0].split("/").filter(t=>t.length>0).pop()}/embed/`},tiktok:{pattern:/tiktok\.com/,getEmbed:t=>{const e=t.split("?")[0].split("#")[0],i=e.match(/\/video\/(\d+)/);return`https://www.tiktok.com/embed/${i?i[1]:e.split("/").filter(t=>t.length>0).pop()}`}},dailymotion:{pattern:/dailymotion\.com|dai\.ly/,getEmbed:(t,e)=>{const i=1==e?1:0;if(t.includes("/playlist/")){return`https://www.dailymotion.com/embed/playlist/${t.split("/playlist/")[1].split("?")[0]}?autoplay=${i}`}return`https://www.dailymotion.com/embed/video/${t.split("/").filter(t=>t.length>0).pop().split("_")[0]}?autoplay=${i}`}}}};this.settings={...e,...t},this.init()}init(){this.scan(),this.setupObserver(),window.addEventListener("aicVideoUpdate",t=>{t.detail&&(this.settings.consent={...this.settings.consent,...t.detail}),this.scan()})}setupObserver(){new MutationObserver(()=>this.scan()).observe(document.body,{childList:!0,subtree:!0})}scan(){document.querySelectorAll(this.settings.selector).forEach(t=>this.process(t))}process(t){const e=t.getAttribute("data-aic-video");if(!e)return;const i=this.detect(e);"local"===i.platform||this.settings.consent[i.platform]?this.renderMedia(t,i):this.renderPlaceholder(t,i.platform)}detect(t){if(!t.startsWith("http"))return{platform:"local",url:t};for(let[e,i]of Object.entries(this.settings.providers))if(i.pattern.test(t))return{platform:e,url:t};return{platform:"local",url:t}}renderMedia(t,e){if("true"===t.getAttribute("data-aic-loaded"))return;const i=t.getAttribute("data-autoplay")||0;let o="";if("local"===e.platform)o=`<video controls ${1==i?"autoplay muted":""} style="width:100%;height:100%;object-fit:cover;"><source src="${e.url}" type="video/mp4"></video>`;else{o=`<iframe src="${this.settings.providers[e.platform].getEmbed(e.url,i)}" width="100%" height="100%" frameborder="0" allowfullscreen allow="autoplay; encrypted-media"></iframe>`}t.innerHTML=o,t.setAttribute("data-aic-loaded","true")}renderPlaceholder(t,e){if(t.querySelector(".aic-placeholder"))return;t.setAttribute("data-aic-loaded","false");const i=this.settings.translations[this.settings.lang]||this.settings.translations.en;t.innerHTML=`\n            <div class="aic-placeholder" style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#1a1a1a;color:#fff;text-align:center;">\n                <p style="margin:0 0 15px;font-size:0.9rem;">${i.msg.replace("{vendor}",e.toUpperCase())}</p>\n                <button class="aic-btn" style="padding:10px 20px;background:#e62117;color:#fff;border:none;cursor:pointer;font-weight:bold;">${i.btn}</button>\n            </div>`,t.querySelector("button").onclick=()=>{window.dispatchEvent(new CustomEvent("aicRequestConsent",{detail:e}))}}}